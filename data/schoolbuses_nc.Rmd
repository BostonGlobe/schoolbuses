```{r setup, cache=FALSE, include=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE)
```
---
title: "schoolbuses"
author: "Gabriel Florit"
output:
  html_document:
    self_contained: false
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(stringr)
library(dplyr)
library(ggplot2)
library(scales)
library(reshape2)
library(lubridate)
setwd("~/Documents/dev/schoolbuses/data")
```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE}
rawdata <- read.table('input/SY1314_AM_Bus_Data_for_the_Globe.txt', sep='\t', header=TRUE)
```

****
Before we begin: our data has `r I(formatC(nrow(rawdata), format='d', big.mark=','))` rows and `r I(ncol(rawdata))` columns.

****
## Global assumptions: we'll call routes that run at least 150 trips per year, **year-round**.

****
Let's start by looking at **bell_late** and **sched_late**. Definitions: **bell_late** is the number of minutes a trip arrived after the bell. **sched_late** is the number of minutes a trip arrived after the scheduled arrival time.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  select(Route, date, bell_late, sched_late) %>%
  melt(id = c('Route', 'date')) %>%
  ggplot() +
  geom_histogram(aes(value)) +
  facet_grid(. ~ variable) +
  scale_y_sqrt(label=comma) +
  ggtitle('Distribution of trip lateness') +
  xlab('minutes') +
  ylab('number of trips (square root scale)')
```

****
The **bell_late** histogram appears to indicate some trips are showing up hours after school starts. But maybe this is the intended behavior? What is the correlation between **bell_late** and **sched_late**?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE, cache=TRUE}
rawdata %>%
  filter(
    !is.na(sched_late),
    !is.na(bell_late)
  ) %>%
  ggplot(aes(sched_late, bell_late)) +
  geom_point() +
  ggtitle('Correlation between sched_late and bell_late') +
  ylab('bell_late (minutes)') +
  xlab('sched_late (minutes)')
```

****
See that vertical line at middle left? That tells us that there are several trips scheduled to arrive hours after **bell_late**. In other words, just because a trip arrived hours after school starts doesn't make it late. There are trips that are scheduled to arrive in the afternoon. But maybe most trips arrive in the morning? What's the average number of trips per route?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
tripsPerRoute <- rawdata %>%
  group_by(Route) %>%
  summarise(yearly.trips = n())

ggplot(tripsPerRoute) +
  geom_histogram(aes(yearly.trips), binwidth=1) +
  scale_y_sqrt() +
  geom_vline(aes(xintercept=median(yearly.trips, na.rm=T)), color='red', linetype='dashed', size=1) +
  ggtitle(str_c('Distribution of yearly trips per route. Median is ', median(tripsPerRoute$yearly.trips) ,' trips.')) +
  xlab('yearly trips') +
  ylab('number of routes (square root scale)')
```

****
Let's focus on routes that run at least 150 trips per year. Which ones have the highest percentage of post-bell arrivals?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
routes.min.150 <- rawdata %>%
  group_by(Route) %>%
  summarise(arrivals = n()) %>%
  filter(arrivals >= 150)

late.routes <- rawdata %>%
  filter(
    !is.na(bell_late),
    bell_late > 0
  ) %>%
  group_by(Route) %>%
  summarise(
    post.bell.arrivals = n(),
    median.bell_late = median(bell_late)
  )

routes.schools <- rawdata %>%
  group_by(Route) %>%
  summarise(
    school = unique(school)[[1]],
    schtype = unique(schtype)[[1]]
  )

late.routes.pct <- routes.min.150 %>%
  inner_join(late.routes, by=c('Route')) %>%
  mutate(post.bell.pct = 100 * post.bell.arrivals/arrivals) %>%
  inner_join(routes.schools, by=c('Route')) %>%
  ungroup() %>%
  arrange(desc(post.bell.pct))

late.routes.pct %>%
  head(10) %>%
  knitr::kable(caption = 'Year-round routes with highest post-bell arrival percentage')
```

****
So far we have been analysing the data starting at routes. Let's use schools and schtype as starting point. First chart: number of post-bell arrivals by school type.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
late.schools <- rawdata %>%
  filter(
    !is.na(bell_late),
    bell_late > 0,
    school != '',
    schtype != ''
  ) %>%
  group_by(school, schtype) %>%
  summarise(
    post.bell.arrivals = n(),
    median.bell_late = median(bell_late) * 1.0
  )

all.schools <- rawdata %>%
  filter(
    school != '',
    schtype != ''
  ) %>%
  group_by(school, schtype) %>%
  summarise(arrivals = n())

late.schools.pct <- late.schools %>%
  inner_join(all.schools, by=c('school', 'schtype')) %>%
  mutate(post.bell.pct = 100 * post.bell.arrivals / arrivals) %>%
  ungroup() %>%
  arrange(desc(post.bell.pct))

late.schools.pct %>%
  group_by(schtype) %>%
  summarise(post.bell.arrivals = sum(post.bell.arrivals)) %>%
  arrange(desc(post.bell.arrivals)) %>%
  ggplot() +
  geom_bar(aes(schtype, post.bell.arrivals), stat='identity') +
  coord_flip()
```

****
Which BPS schools have the highest percentage of post-bell arrivals?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
late.schools.pct %>%
  filter(schtype == 'BPS') %>%
  select(-schtype) %>%
  head(10) %>%
  knitr::kable(caption = 'BPS schools with highest post-bell arrival percentage')
```

****
Which year-round routes reported no arrival data?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
routes.no.data <- rawdata %>%
  filter(errortype == 'No Arrival Data') %>%
  group_by(Route) %>%
  summarise(no.data.count = n())

routes.min.150 %>%
  inner_join(routes.no.data, by=c('Route')) %>%
  inner_join(routes.schools, by=c('Route')) %>%
  ungroup() %>%
  arrange(desc(no.data.count)) %>%
  head(10) %>%
  knitr::kable(caption='Year-round routes with most "No Arrival Data"')
```

****
Which schools reported no arrival data?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  filter(errortype == 'No Arrival Data') %>%
  group_by(school, schtype) %>%
  summarise(no.data.count = n()) %>%
  inner_join(all.schools, by=c('school', 'schtype')) %>%
  mutate(no.data.pct = 100*no.data.count/arrivals) %>%
  ungroup() %>%
  arrange(desc(no.data.count)) %>%
  head(10) %>%
  knitr::kable(caption='Schools with most "No Arrival Data"')
```

****
What days/routes stand out as really bad bus commutes? Where were they going? What day of the week was it?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
routes.min.150 %>%
  inner_join(rawdata, by=c('Route')) %>%
  filter(!is.na(bell_late), bell_late > 0) %>%
  arrange(desc(bell_late)) %>%
  select(Route, bell_late, school, schtype, students, date, dow) %>%
  head(10) %>%
  knitr::kable(caption='Highest post-bell arrival for year-round routes')
```

****
What percentage of these buses reached the school before or at their scheduled time? Before or at the bell?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  filter(!is.na(bell_late)) %>%
  mutate(bell.late = bell_late > 0) %>%
  group_by(bell.late) %>%
  tally() %>%
  mutate(pct = 100*n/sum(n)) %>%
  knitr::kable(caption='Percent of trips arriving after bell')

rawdata %>%
  filter(!is.na(sched_late)) %>%
  mutate(sched.late = sched_late > 0) %>%
  group_by(sched.late) %>%
  tally() %>%
  mutate(pct = 100*n/sum(n)) %>%
  knitr::kable(caption='Percent of trips arriving after scheduled arrival')
```


