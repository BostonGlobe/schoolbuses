```{r setup, cache=FALSE, include=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE)
```

---
title: "schoolbuses - main"
author: "Gabriel Florit"
output:
  html_document:
    self_contained: false
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(stringr)
library(dplyr)
library(ggplot2)
library(scales)
library(reshape2)
library(lubridate)
setwd("~/Documents/dev/schoolbuses/data")
```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE}
rawdata <- read.table('input/SY1314_AM_Bus_Data_for_the_Globe.txt', sep='\t', header=TRUE)
```

Calculate various datasets.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}

lateTrips <- rawdata %>%
  filter(
    errortype == '',
    !is.na(PlannedAnchorTime),
    !is.na(ActualArrivalTime),
    !is.na(belltime)
  ) %>%
  mutate(
    date = dmy(date),
    PlannedAnchorTime = hm(PlannedAnchorTime)/minutes(1),
    ActualArrivalTime = hm(ActualArrivalTime)/minutes(1),
    belltime = hm(belltime)/minutes(1)
  ) %>%
  filter(
    PlannedAnchorTime <= belltime
  ) %>%
  mutate(
    late.minutes = ActualArrivalTime - belltime,
    is.late = ActualArrivalTime > belltime
  ) %>%
  filter(late.minutes > -5) %>%
  mutate(late.minutes = late.minutes + 5) %>%
  group_by(date, late.minutes) %>%
  tally() %>%
  rename(count = n) %>%
  arrange(date)

lateTripsPerDay <- lateTrips %>%
  group_by(date) %>%
  summarise(late.trips = sum(count)) %>%
  arrange(date)

tripsPerDay <- rawdata %>%
  filter(
    errortype == '',
    schtype == 'BPS'
  ) %>%
  mutate(date = dmy(date)) %>%
  group_by(date) %>%
  tally() %>%
  rename(total.trips = n) %>%
  inner_join(lateTripsPerDay, by=c('date')) %>%
  mutate(early.trips = total.trips - late.trips) %>%
  arrange(date)

write.csv(lateTrips, 'output/lateTrips.csv', row.names=F)
write.csv(tripsPerDay, 'output/tripsPerDay.csv', row.names=F)
```

****
This is a story about buses. Boston Public School buses.
On any given day, hundreds of buses carry thousands of kids to school. Here's September 4, the first day of classes.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
tripsPerDay %>%
  mutate(is.first = row_number() == 1) %>%
  head(3) %>%
  ggplot(aes(date, total.trips, alpha=is.first)) +
  geom_bar(stat='identity') +
  theme(legend.position='none') +
  scale_alpha_manual(values=c(0, 1)) +
  ylab('bus trips')
```

****
And here's the rest of the year.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
tripsPerDay %>%
  ggplot(aes(date, total.trips)) +
  geom_bar(stat='identity') +
  theme(legend.position='none') +
  ylab('bus trips')
```

****
Over 14% of buses arrived late.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
data <- melt(tripsPerDay, id=c('date')) %>%
  filter(variable %in% c('early.trips', 'late.trips'))

ggplot(data, aes(date, value, fill=variable, color=variable)) +
  geom_bar(stat='identity') +
  scale_colour_manual(values=c('#ea212d', 'grey80')) +
  theme(legend.position='none') +
  ylab('bus trips')
```

```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
ggplot(tripsPerDay, aes(date, late.trips)) +
  geom_bar(stat='identity', fill='#ea212d')
```

****
On the first day of school, 648 buses show up after the bell.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
tripsPerDay %>%
  mutate(is.first = row_number() == 1) %>%
  head(3) %>%
  ggplot(aes(date, late.trips, alpha=is.first)) +
  geom_bar(stat='identity', fill='#ea212d') +
  theme(legend.position='none') +
  scale_alpha_manual(values=c(0, 1))
```

****
Most tardy buses arrive about 15 minutes late on the first day of school, but some show up over 90 minutes after the bell.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
lateTrips %>%
  filter(date == ymd('2013-09-04')) %>%
  ggplot(aes(late.minutes, count, late.minutes)) +
  coord_flip() +
  geom_bar(stat='identity', fill='#ea212d')
```

****
Over the school year, as drivers become familiar with their routes, tardiness decreases. But buses continue to arrive late.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
lateTrips %>%
  ggplot(aes(date, late.minutes)) +
  geom_point(colour='#ea212d', size = 1)
```

****
What about looking at the first week?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
data <- lateTrips %>%
  filter(floor_date(date, 'week') == ymd('2013-09-01'))

write.csv(data, 'output/a1_teaser.csv', row.names=F)

ggplot(data, aes(date, late.minutes)) +
  geom_point(aes(size=count), colour='#ea212d') +
  geom_point(shape=1, aes(size=count), colour='#59080d') +
  scale_size_area(max_size=9)
```

```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
lateTrips %>%
  filter(floor_date(date, 'week') == ymd('2013-09-01')) %>%
  ggplot(aes(late.minutes, count, late.minutes)) +
  coord_flip() +
  geom_bar(stat='identity', fill='#ea212d') +
  facet_grid(. ~ date)
```
