---
title: "schoolbuses"
author: "Gabriel Florit"
output:
  html_document:
    self_contained: false
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(stringr)
library(dplyr)
library(ggplot2)
library(scales)
library(reshape2)
library(lubridate)
setwd("~/Documents/dev/schoolbuses/data")
```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE}
rawdata <- read.table('input/SY1314_AM_Bus_Data_for_the_Globe.txt', sep='\t', header=TRUE)
```

****
Before we begin: our data has `r I(formatC(nrow(rawdata), format='d', big.mark=','))` rows and `r I(ncol(rawdata))` columns.

****
Are any routes consistently late? Let's take a closer look at **bell_late** and **sched_late**. Definitions: **bell_late** is the number of minutes a bus arrived after the bell. **sched_late** is the number of minutes a bus arrived after the scheduled arrival time.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  select(Route, date, bell_late, sched_late) %>%
  melt(id = c('Route', 'date')) %>%
  ggplot() +
  geom_histogram(aes(value)) +
  facet_grid(. ~ variable) +
  scale_y_sqrt(label=comma) +
  ggtitle('Distribution of route lateness') +
  xlab('minutes') +
  ylab('number of routes (square root scale)')
```

****
The **bell_late** histogram appears to indicate some routes are showing up hours after school starts. But maybe this is the intended behavior? What is the correlation between **bell_late** and **sched_late**?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  filter(
    !is.na(sched_late),
    !is.na(bell_late)
  ) %>%
  ggplot(aes(sched_late, bell_late)) +
  geom_point() +
  ggtitle('Correlation between sched_late and bell_late') +
  ylab('bell_late (minutes)') +
  xlab('sched_late (minutes)')
```

****
See that vertical line at middle left? That tells us that there are several routes scheduled to arrive hours after **bell_late**. In other words, just because a route arrived hours after school starts doesn't make it late. There are routes that are scheduled to arrive in the afternoon. But maybe most routes arrive in the morning? This leads us to the next question: what's the average number of trips per route?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
data <- rawdata %>%
  group_by(Route) %>%
  summarise(yearly.trips = n())

ggplot(data) +
  geom_histogram(aes(yearly.trips), binwidth=1) +
  scale_y_sqrt() +
  geom_vline(aes(xintercept=median(yearly.trips, na.rm=T)), color='red', linetype='dashed', size=1) +
  ggtitle(str_c('Distribution of yearly trips per route. Median is ', median(data$yearly.trips) ,' trips.')) +
  xlab('yearly trips') +
  ylab('number of routes (square root scale)')
```

****
Let's focus on routes that run at least 150 trips per year. Which ones are consistently late?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
data <- rawdata %>%
  group_by(Route) %>%
  summarise(trips = n()) %>%
  filter(trips >= 150) %>%
  select(Route) %>%
  inner_join(rawdata, by=c('Route'))

ggplot(data) +
  geom_histogram(aes(bell_late)) +
  scale_y_sqrt(label=comma) +
  geom_vline(aes(xintercept=median(bell_late, na.rm=T)), color='red', linetype='dashed', size=1) +
  ggtitle(str_c('Distribution of bell_late for routes with at least 150 yearly trips. Median is ', median(data$bell_late, na.rm=T), ' minute')) +
  xlab('bell_late (minutes)') +
  ylab('number of routes (square root scale)')
```
















 Let's focus on **sched_late** instead. Let's look at the distribution again, and we'll use a log axis on the y scale. The red line is the median.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  filter(
    !is.na(sched_late),
    !is.na(bell_late)
  ) %>%
  ggplot() +
  geom_histogram(aes(sched_late)) +
  scale_y_log10(labels=comma) +
  geom_vline(aes(xintercept=median(sched_late, na.rm=T)), color='red', linetype='dashed', size=1) +
  ggtitle('Distribution of sched_late per route') +
  xlab('sched_late (minutes)') +
  ylab('number of routes (log scale)')
```

****
This tells us that on average, buses arrive at their destination one minute after scheduled arrival. But the distribution has a long tail - thousands of buses are arriving over 30 minutes late. Which ones? Let's look at the routes with worst average arrival times.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  filter(!is.na(sched_late)) %>%
  group_by(Route) %>%
  summarise(
    median.sched_late = median(sched_late),
    trips = n()
  ) %>%
  arrange(desc(median.sched_late)) %>%
  head(10) %>%
  knitr::kable()
```

****
The worst route averaged over 100 minutes after scheduled arrival, but it only took 8 trips. Which leads to the next question: 

