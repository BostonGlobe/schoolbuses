---
title: "schoolbuses"
author: "Gabriel Florit"
output:
  html_document:
    self_contained: false
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(stringr)
library(dplyr)
library(ggplot2)
library(scales)
library(reshape2)
library(lubridate)
setwd("~/Documents/dev/schoolbuses/data")
```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE}
rawdata <- read.table('input/SY1314_AM_Bus_Data_for_the_Globe.txt', sep='\t', header=TRUE)
```

The following is an analysis of the school buses data.

A note on the format: each question is followed by the R code that generates the answer. This is also known as **reproducible research**, a practice that's slowly being adopted by newspapers (e.g. [538](https://github.com/fivethirtyeight/data), [The Upshot](https://github.com/theupshot)). From [wikipedia](http://en.wikipedia.org/wiki/Reproducibility#Reproducible_research): "The term reproducible research refers to the idea that the ultimate product of academic research is the paper along with the full computational environment used to produce the results in the paper such as the code, data, etc. that can be used to reproduce the results and create new work based on the research."

****
Before we begin: our data has `r I(formatC(nrow(rawdata), format='d', big.mark=','))` rows and `r I(ncol(rawdata))` columns.

****
Are any routes consistently late? Let's take a closer look at **bell_late** and **sched_late**. Definitions: **bell_late** is the number of minutes a bus arrived after the bell. **sched_late** is the number of minutes a bus arrived after the scheduled arrival time.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  select(Route, date, bell_late, sched_late) %>%
  melt(id = c('Route', 'date')) %>%
  ggplot() +
  geom_histogram(aes(value)) +
  facet_grid(. ~ variable) +
  scale_y_sqrt(label=comma) +
  ggtitle('Distribution of trip lateness') +
  xlab('minutes') +
  ylab('number of routes (square root scale)')
```

****
The **bell_late** histogram appears to indicate some routes are showing up hours after school starts. But maybe this is the intended behavior? What is the correlation between **bell_late** and **sched_late**?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  filter(
    !is.na(sched_late),
    !is.na(bell_late)
  ) %>%
  ggplot(aes(sched_late, bell_late)) +
  geom_point() +
  ggtitle('Correlation between sched_late and bell_late') +
  ylab('bell_late (minutes)') +
  xlab('sched_late (minutes)')
```

****
See that vertical line at middle left? That tells us that there are several routes scheduled to arrive hours after **bell_late**. In other words, just because a route arrived hours after school starts doesn't make it late. There are routes that are scheduled to arrive in the afternoon. But maybe most routes arrive in the morning? This leads us to the next question: what's the average number of trips per route?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
data <- rawdata %>%
  group_by(Route) %>%
  summarise(yearly.trips = n())

ggplot(data) +
  geom_histogram(aes(yearly.trips), binwidth=1) +
  scale_y_sqrt() +
  geom_vline(aes(xintercept=median(yearly.trips, na.rm=T)), color='red', linetype='dashed', size=1) +
  ggtitle(str_c('Distribution of yearly trips per route. Median is ', median(data$yearly.trips) ,' trips.')) +
  xlab('yearly trips') +
  ylab('number of routes (square root scale)')
```

****
Let's focus on routes that run at least 150 trips per year.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  group_by(Route) %>%
  summarise(trips = n()) %>%
  filter(trips >= 150) %>%
  select(Route) %>%
  inner_join(rawdata, by=c('Route')) %>%
  filter(!is.na(bell_late)) %>%
  group_by(Route) %>%
  summarise(median.bell_late = median(bell_late)) %>%
  ggplot() +
  geom_histogram(aes(median.bell_late)) +
  scale_y_sqrt(label=comma) +
  xlab('median bell_late (minutes)') +
  ylab('number of routes (square root scale)') +
  ggtitle('Distribution of route median bell_late')
```

****
According to this chart, there are year-round routes that consistently arrive after school starts! Which ones are the worst offenders?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  group_by(Route) %>%
  summarise(trips = n()) %>%
  filter(trips >= 150) %>%
  select(Route) %>%
  inner_join(rawdata, by=c('Route')) %>%
  filter(!is.na(bell_late)) %>%
  group_by(Route) %>%
  summarise(median.bell_late = median(bell_late)) %>%
  inner_join(rawdata, by=c('Route')) %>%
  select(Route, median.bell_late, school, schtype) %>%
  group_by(Route) %>%
  summarise(
    median.bell_late = unique(median.bell_late)[[1]],
    school = unique(school)[[1]],
    schtype = unique(schtype)[[1]]
  ) %>%
  ungroup() %>%
  arrange(desc(median.bell_late)) %>%
  head() %>%
  knitr::kable()
```
