---
title: "schoolbuses"
author: "Gabriel Florit"
output:
  html_document:
    self_contained: false
---

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(stringr)
library(dplyr)
library(ggplot2)
library(scales)
library(reshape2)
library(lubridate)
setwd("~/Documents/dev/schoolbuses/data")
```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=TRUE}
rawdata <- read.table('input/SY1314_AM_Bus_Data_for_the_Globe.txt', sep='\t', header=TRUE)
```

The following is an analysis of the school buses data.

A note on the format: each question is followed by the R code that generates the answer. This is also known as **reproducible research**, a practice that's slowly being adopted by newspapers (e.g. [538](https://github.com/fivethirtyeight/data), [The Upshot](https://github.com/theupshot)). From [wikipedia](http://en.wikipedia.org/wiki/Reproducibility#Reproducible_research): "The term reproducible research refers to the idea that the ultimate product of academic research is the paper along with the full computational environment used to produce the results in the paper such as the code, data, etc. that can be used to reproduce the results and create new work based on the research."

****
Before we begin: our data has `r I(formatC(nrow(rawdata), format='d', big.mark=','))` rows and `r I(ncol(rawdata))` columns.

****
Let's start by looking at **bell_late** and **sched_late**. Definitions: **bell_late** is the number of minutes a trip arrived after the bell. **sched_late** is the number of minutes a trip arrived after the scheduled arrival time.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  select(Route, date, bell_late, sched_late) %>%
  melt(id = c('Route', 'date')) %>%
  ggplot() +
  geom_histogram(aes(value)) +
  facet_grid(. ~ variable) +
  scale_y_sqrt(label=comma) +
  ggtitle('Distribution of trip lateness') +
  xlab('minutes') +
  ylab('number of trips (square root scale)')
```

****
The **bell_late** histogram appears to indicate some trips are showing up hours after school starts. But maybe this is the intended behavior? What is the correlation between **bell_late** and **sched_late**?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
rawdata %>%
  filter(
    !is.na(sched_late),
    !is.na(bell_late)
  ) %>%
  ggplot(aes(sched_late, bell_late)) +
  geom_point() +
  ggtitle('Correlation between sched_late and bell_late') +
  ylab('bell_late (minutes)') +
  xlab('sched_late (minutes)')
```

****
See that vertical line at middle left? That tells us that there are several trips scheduled to arrive hours after **bell_late**. In other words, just because a trip arrived hours after school starts doesn't make it late. There are trips that are scheduled to arrive in the afternoon. But maybe most trips arrive in the morning? What's the average number of trips per route?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
tripsPerRoute <- rawdata %>%
  group_by(Route) %>%
  summarise(yearly.trips = n())

ggplot(tripsPerRoute) +
  geom_histogram(aes(yearly.trips), binwidth=1) +
  scale_y_sqrt() +
  geom_vline(aes(xintercept=median(yearly.trips, na.rm=T)), color='red', linetype='dashed', size=1) +
  ggtitle(str_c('Distribution of yearly trips per route. Median is ', median(tripsPerRoute$yearly.trips) ,' trips.')) +
  xlab('yearly trips') +
  ylab('number of routes (square root scale)')
```

****
Let's focus on routes that run at least 150 trips per year.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
routesMin150MedianBellLate <- rawdata %>%
  group_by(Route) %>%
  summarise(trips = n()) %>%
  filter(trips >= 150) %>%
  select(Route) %>%
  inner_join(rawdata, by=c('Route')) %>%
  filter(!is.na(bell_late)) %>%
  group_by(Route) %>%
  summarise(median.bell_late = median(bell_late))
  
ggplot(routesMin150MedianBellLate) +
  geom_histogram(aes(median.bell_late)) +
  scale_y_sqrt(label=comma) +
  xlab('median bell_late (minutes)') +
  ylab('number of routes (square root scale)') +
  ggtitle('Distribution of median bell_late for routes with at least 150 yearly trips')
```

****
According to this chart, there are year-round routes that consistently arrive after school starts! Which ones are the worst offenders?
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
routesMin150MedianBellLateExtra <- routesMin150MedianBellLate %>% 
  inner_join(rawdata, by=c('Route')) %>%
  select(Route, median.bell_late, school, schtype) %>%
  group_by(Route) %>%
  summarise(
    median.bell_late = unique(median.bell_late)[[1]],
    school = unique(school)[[1]],
    schtype = unique(schtype)[[1]]
  ) %>%
  ungroup() %>%
  arrange(desc(median.bell_late))

routesMin150MedianBellLateExtra %>%
  head(10) %>%
  knitr::kable(caption = 'Median bell_late for routes with at least 150 yearly trips')
```

****
Notice how the worst three routes go to school type **Pri SPED**. Let's look at the distribution of route median bell_late by school type.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
routesMin150MedianBellLateExtra %>%
  filter(median.bell_late > 0) %>%
  ggplot() +
  geom_histogram(aes(median.bell_late)) +
  facet_grid(. ~ schtype, scales='free') +
  ggtitle('Distribution of route median bell_late > 0 by school type, for routes with at least 150 yearly trips') +
  xlab('median bell_late (minutes)') +
  ylab('number of routes')
```

****
There are only a handful of routes that consistently arrive late. Let's see the full list.
```{r, results='asis', fig.width=10, fig.height=4, warning=FALSE, message=FALSE}
routesMin150MedianBellLateExtra %>%
  filter(median.bell_late > 0) %>%
  knitr::kable(caption = 'Routes with median bell_late greater than zero, for routes with at least 150 yearly trips')
```
